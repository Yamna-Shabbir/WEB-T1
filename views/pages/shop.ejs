<%
function buildQueryString(category, minPrice, maxPrice) {
  let query = '';
  if (category && category !== 'all') query += '&category=' + category;
  if (minPrice) query += '&minPrice=' + minPrice;
  if (maxPrice) query += '&maxPrice=' + maxPrice;
  return query;
}

let bodyContent = `
<div class="shop-page">

  <h1 class="shop-heading">Shop</h1>

  <!-- FILTER BAR -->
  <div class="filter-wrapper">
    <form method="GET" action="/shop" class="filter-bar">

      <select name="category">
        <option value="all"${currentCategory === 'all' ? ' selected' : ''}>All Categories</option>
`;

categories.forEach(cat => {
  bodyContent += `<option value="${cat}"${currentCategory === cat ? ' selected' : ''}>${cat}</option>`;
});

bodyContent += `
      </select>

      <input type="number" name="minPrice" placeholder="Min Price"
        value="${currentMinPrice || ''}" min="0" step="0.01">

      <input type="number" name="maxPrice" placeholder="Max Price"
        value="${currentMaxPrice || ''}" min="0" step="0.01">

      <button class="btn btn-primary">Apply</button>
      <a href="/shop" class="btn btn-light">Clear</a>

    </form>
  </div>

  <!-- INFO -->
  <div class="shop-info">
    Showing ${products.length} of ${totalProducts} products
    ${(currentCategory !== 'all' || currentMinPrice || currentMaxPrice)
      ? '<span class="badge bg-info ms-2">Filtered</span>' : ''}
  </div>
`;

// Error message handling
if (typeof error !== 'undefined' && error) {
  bodyContent += `<div class="alert alert-danger text-center">${error}</div>`;
}

if (products && products.length > 0) {
  bodyContent += `<div class="grid-container">`;

  products.forEach(product => {
    bodyContent += `
      <div class="product-card">
        <img src="${product.image}" alt="${product.name}"
             onerror="this.src='/images/image.png'">

        <div class="card-body">
          <h3 class="product-title">${product.name}</h3>
          <p class="product-desc">${product.description}</p>
        </div>

        <div class="card-footer">
          <span class="price">$${product.price.toFixed(2)}</span>
          <button class="btn btn-sm btn-primary"${product.stock === 0 ? ' disabled' : ''}>
            ${product.stock === 0 ? 'Out of Stock' : 'Add to Cart'}
          </button>
        </div>
      </div>
    `;
  });

  bodyContent += `</div>`;

  if (totalPages > 1) {
    const q = buildQueryString(currentCategory, currentMinPrice, currentMaxPrice);
    bodyContent += `<div class="pagination">`;

    for (let i = 1; i <= totalPages; i++) {
      bodyContent += `
        <a href="?page=${i}${q}" class="${i === currentPage ? 'active' : ''}">
          ${i}
        </a>
      `;
    }

    bodyContent += `</div>`;
  }
} else {
  bodyContent += `<div class="alert alert-info text-center">No products found</div>`;
}

bodyContent += `
<style>

  /* PAGE */
  .shop-page {
    background: #f4f6f8;
    padding: 40px 20px 60px;
  }

  .shop-heading {
    text-align: center;
    margin-bottom: 25px;
  }

  /* FILTER BAR */
  .filter-wrapper {
    position: sticky;
    top: 70px;
    z-index: 10;
    display: flex;
    justify-content: center;
    margin-bottom: 30px;
  }

  .filter-bar {
    background: #fff;
    padding: 12px 15px;
    display: flex;
    gap: 10px;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,.08);
  }

  .filter-bar select,
  .filter-bar input {
    padding: 8px 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
  }

  /* INFO */
  .shop-info {
    text-align: center;
    margin-bottom: 25px;
    color: #555;
  }

  /* GRID */
  .grid-container {
    max-width: 1200px;
    margin: auto;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 25px;
  }

  /* CARD */
  .product-card {
    background: #fff;
    border-radius: 14px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 6px 15px rgba(0,0,0,.1);
    transition: transform .25s;
  }

  .product-card:hover {
    transform: translateY(-6px);
  }

  .product-card img {
    height: 190px;
    width: 100%;
    object-fit: cover;
  }

  /* CARD BODY */
  .card-body {
    padding: 14px;
    display: flex;
    flex-direction: column;
    gap: 6px; /* spacing between product name and description */
  }

  .product-title {
    font-size: 1.15rem;
    font-weight: 600;
    margin: 0; /* remove extra margin */
    color: #111;
    line-height: 1.3;
  }

  .product-desc {
    font-size: 0.85rem;
    color: #555;
    line-height: 1.4;
    margin: 0; /* remove extra margin */
  }

  /* FOOTER */
  .card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 14px;
    border-top: 1px solid #eee;
  }

  .price {
    font-weight: 600;
    color: #2727E9;
  }

  /* PAGINATION */
  .pagination {
    display: flex;
    justify-content: center;
    margin-top: 40px;
    gap: 10px;
  }

  .pagination a {
    padding: 8px 14px;
    background: #fff;
    border-radius: 6px;
    text-decoration: none;
    color: #333;
    box-shadow: 0 2px 6px rgba(0,0,0,.08);
  }

  .pagination a.active {
    background: #2727E9;
    color: #fff;
  }

  /* RESPONSIVE */
  @media (max-width: 992px) {
    .grid-container {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 576px) {
    .grid-container {
      grid-template-columns: 1fr;
    }

    .filter-bar {
      flex-direction: column;
    }
  }

</style>
</div>
`;%>

<%- include('../layout', {
  title: 'Shop',
  page: 'shop',
  body: bodyContent
}) %>
